# å·¥ä½œæµåç§°
name: AI PR Summarizer (OpenAI - Hardcoded)

# è§¦å‘å™¨ï¼šå½“æœ‰æ–°çš„ Pull Request è¢«æ‰“å¼€æˆ–åŒæ­¥ï¼ˆæœ‰æ–°çš„ commitï¼‰æ—¶
on:
  pull_request:
    types: [opened, synchronize]

# ä»»åŠ¡æ‰€éœ€æƒé™
permissions:
  pull-requests: write # å…è®¸åœ¨ PR ä¸­å‘è¡¨è¯„è®º
  contents: read      # å…è®¸è¯»å–ä»£ç å†…å®¹

jobs:
  summarize_pr:
    runs-on: ubuntu-latest

    steps:
      # ç¬¬ä¸€æ­¥ï¼šæ£€å‡ºä»£ç ï¼Œéœ€è¦å®Œæ•´å†å²æ¥è·å– diff
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ç¬¬äºŒæ­¥ï¼šè·å– PR çš„ä»£ç å˜æ›´å†…å®¹
      - name: Get PR Diff
        id: get_diff
        run: |
          DIFF_CONTENT=$(git diff origin/${{ github.base_ref }} ... HEAD)
          DIFF_JSON=$(echo "$DIFF_CONTENT" | jq -R -s .)
          echo "diff_for_prompt=${DIFF_JSON}" >> $GITHUB_OUTPUT

      # ç¬¬ä¸‰æ­¥ï¼šè°ƒç”¨ OpenAI API å¹¶å‘è¡¨è¯„è®º
      - name: Call OpenAI and Post Summary Comment
        uses: actions/github-script@v7
        with:
          script: |
            const diff = process.env.DIFF_CONTENT;
            if (!diff || diff.trim() === '') {
              console.log('No code changes detected. Skipping summary.');
              return;
            }

            const { data: comment } = await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `### ğŸ¤– AI æ­£åœ¨åˆ†æä»£ç å˜æ›´...\n\nè¯·ç¨å...`
            });

            const prompt = `Please act as a senior software engineer. Summarize the following code changes from a pull request in a concise and easy-to-understand way. Use Chinese for your summary. The summary should be in markdown format. Diff:\n${diff}`;

            try {
              // â—ï¸ å·²å°†ç«¯ç‚¹ç›´æ¥å†™å…¥
              const apiEndpoint = 'https://gpt.chats2gpt.com/v1/chat/completions';
              
              const response = await fetch(apiEndpoint, {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  // â—ï¸ å·²å°† Token ç›´æ¥å†™å…¥
                  'Authorization': 'Bearer apple888'
                },
                body: JSON.stringify({
                  // â—ï¸ å·²ä½¿ç”¨ä½ æŒ‡å®šçš„ gpt5 æ¨¡å‹
                  model: 'gpt5', 
                  max_tokens: 1024,
                  messages: [{ role: 'user', content: prompt }]
                })
              });

              if (!response.ok) {
                throw new Error(`API request failed with status ${response.status}: ${await response.text()}`);
              }

              const data = await response.json();
              const summary = data.choices[0].message.content;

              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: comment.id,
                body: `### ğŸ¤– AI ä»£ç å˜æ›´æ€»ç»“\n\n${summary}`
              });

            } catch (error) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: comment.id,
                body: `### âŒ AI æ€»ç»“å¤±è´¥\n\næŠ±æ­‰ï¼Œåœ¨è°ƒç”¨ AI API æ—¶é‡åˆ°é”™è¯¯ï¼š\n\`\`\`\n${error.message}\n\`\`\`\`
              });
              throw error;
            }
        env:
          DIFF_CONTENT: ${{ steps.get_diff.outputs.diff_for_prompt }}
