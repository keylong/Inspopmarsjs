name: Vercel Auto-Fix Suggester (Chinese Prompt)

on:
  check_run:
    types: [completed]

jobs:
  suggest-fix-for-vercel-error:
    if: contains(github.event.check_run.name, 'Vercel') && github.event.check_run.conclusion == 'failure'
    
    runs-on: ubuntu-latest
    
    permissions:
      pull-requests: write
      contents: read
      checks: read

    steps:
      - name: 'Announce: Vercel deployment failed, generating fix suggestion'
        run: echo "Vercel check '${{ github.event.check_run.name }}' failed. Starting Claude suggestion process..."

      - name: Checkout PR Branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.check_run.pull_requests[0].ref }}

      - name: Install Vercel CLI
        run: npm install -g vercel

      - name: Fetch Failed Vercel Deployment Logs
        id: get_logs
        run: |
          echo "Fetching logs from deployment URL: ${{ github.event.check_run.details_url }}"
          LOGS=$(vercel logs ${{ github.event.check_run.details_url }} --token=${{ secrets.VERCEL_TOKEN }} --project=${{ secrets.VERCEL_PROJECT_ID }} --org=${{ secrets.VERCEL_ORG_ID }})
          echo "logs<<EOF" >> $GITHUB_OUTPUT
          echo "$LOGS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Generate Fix Suggestion with Claude (Chinese Prompt)
        id: claude_suggestion
        uses: anthropics/claude-code-action@beta
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          # â—ï¸ å·²ç§»é™¤ model: "..."ï¼Œå°†ä½¿ç”¨é»˜è®¤æ¨¡å‹
          
          # â—ï¸ å·²å°† Prompt æ›¿æ¢ä¸ºé«˜è´¨é‡çš„ä¸­æ–‡ç‰ˆæœ¬
          direct_prompt: |
            ä½ æ˜¯ä¸€ä½ç²¾é€š Vercel éƒ¨ç½²é—®é¢˜è°ƒè¯•çš„å…¨æ ˆå¼€å‘ä¸“å®¶ã€‚
            æˆ‘çš„ä¸€ä¸ª Vercel éƒ¨ç½²æ„å»ºå¤±è´¥äº†ã€‚ä½ çš„ä»»åŠ¡æ˜¯åˆ†æä¸‹é¢çš„æ„å»ºæ—¥å¿—ï¼Œæ‰¾å‡ºæ ¹æœ¬åŸå› ï¼Œå¹¶æå‡ºå…·ä½“çš„ä»£ç ä¿®å¤æ–¹æ¡ˆã€‚

            **è¾“å‡ºè¦æ±‚:**
            1. ä½ çš„è¾“å‡ºæ ¼å¼å¿…é¡»æ˜¯ä¸€æ¡ç»“æ„æ¸…æ™°ã€å¯¹å¼€å‘è€…å‹å¥½çš„ GitHub è¯„è®ºã€‚
            2. è¯·å…ˆå¯¹é—®é¢˜çš„æ ¹æºè¿›è¡Œç®€è¦åˆ†æã€‚
            3. ç„¶ååœ¨ä¸€ä¸ª GitHub é£æ ¼çš„ Markdown ä»£ç å—ä¸­ï¼ˆä¾‹å¦‚ ```javascriptï¼‰ï¼Œæä¾›å…·ä½“çš„ä»£ç ä¿®å¤å»ºè®®ã€‚
            4. è¯·ä»¥ '### ğŸ¤– Claude è‡ªåŠ¨ä¿®å¤å»ºè®®' ä½œä¸ºä½ å›å¤çš„æ ‡é¢˜ã€‚

            ä»¥ä¸‹æ˜¯å¤±è´¥éƒ¨ç½²çš„æ„å»ºæ—¥å¿—:
            ```
            ${{ steps.get_logs.outputs.logs }}
            ```
        # â—ï¸ æ–°å¢ env æ¨¡å—ï¼Œä½¿ç”¨ä½ çš„è‡ªå®šä¹‰ç«¯ç‚¹
        env:
          # ä½¿ç”¨ä½ å­˜å‚¨åœ¨ Secret ä¸­çš„è‡ªå®šä¹‰ç«¯ç‚¹
          ANTHROPIC_BASE_URL: ${{ secrets.ANTHROPIC_BASE_URL }}

      - name: Post Fix Suggestion to Pull Request
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ github.event.check_run.pull_requests[0].number }};
            const prAuthor = "${{ github.event.check_run.pull_requests[0].user.login }}";
            const suggestion = `${{ steps.claude_suggestion.outputs.claude_response }}`;

            const commentBody = `
            ä½ å¥½ @${prAuthor}ï¼Œ

            æœ¬æ¬¡ Vercel éƒ¨ç½²æ„å»ºå¤±è´¥äº†ã€‚æˆ‘åˆ†æäº†æ„å»ºæ—¥å¿—ï¼Œå¹¶æä¾›äº†ä¸€ä¸ªæˆ–è®¸å¯ä»¥è§£å†³é—®é¢˜çš„ä¿®å¤å»ºè®®ã€‚

            ---

            ${suggestion}

            ---
            *è¿™æ˜¯ä¸€æ¡ç”± AI è‡ªåŠ¨ç”Ÿæˆçš„å»ºè®®ï¼Œè¯·åœ¨é‡‡çº³å‰ä»”ç»†å®¡æŸ¥ã€‚*
            `;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: commentBody
            });
