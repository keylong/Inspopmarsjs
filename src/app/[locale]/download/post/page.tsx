'use client';

export const dynamic = 'force-dynamic';

import { useState, useRef, useEffect } from 'react';
import Link from 'next/link';
import Image from 'next/image';
import { motion } from 'framer-motion';
import { 
  Download,
  Image as ImageIcon,
  Film,
  Link as LinkIcon,
  ArrowLeft,
  CheckCircle,
  AlertCircle,
  Loader2,
  Copy,
  Instagram,
  ZoomIn,
  X,
  Play
} from 'lucide-react';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Alert, AlertDescription } from '@/components/ui/alert';
import { useCurrentLocale, useI18n } from '@/lib/i18n/client';
import { useSearchParams } from 'next/navigation';
import { useOptionalAuth } from '@/hooks/useAuth';
import { useToast } from '@/lib/hooks/use-toast';

import { InstagramPost, DownloadItem } from '@/types/instagram';
import { generateImageSrc, isVideoUrl, generateVideoSrc } from '@/lib/utils/media-proxy';
import { VideoPreviewModal } from '@/components/ui/video-preview-modal';
import { PremiumUpgradeModal } from '@/components/ui/premium-upgrade-modal';
import { IPLimitModal } from '@/components/ui/ip-limit-modal';

// ÁîüÊàêÂÜÖËÅîSVGÂç†‰ΩçÁ¨¶
const generatePlaceholder = (width: number, height: number, text: string) => {
  const svgContent = `
    <svg width="${width}" height="${height}" xmlns="http://www.w3.org/2000/svg">
      <rect width="100%" height="100%" fill="#f3f4f6"/>
      <text x="50%" y="50%" text-anchor="middle" dominant-baseline="central" 
            font-family="Arial, sans-serif" font-size="14" fill="#9ca3af">
        ${text}
      </text>
    </svg>
  `.trim();
  
  // ‰ΩøÁî® encodeURIComponent Êõø‰ª£ btoa Êù•Â§ÑÁêÜ‰∏≠ÊñáÂ≠óÁ¨¶
  return `data:image/svg+xml;charset=utf-8,${encodeURIComponent(svgContent)}`;
};

interface DownloadResult {
  success: boolean;
  data?: InstagramPost;
  downloads?: DownloadItem[];
  error?: string;
  _mode?: string;
  needsUpgrade?: boolean;
  meta?: {
    remainingUsage?: number;
    usageDeducted?: boolean;
    userAuthenticated?: boolean;
    actualQuality?: string;
    requestedQuality?: string;
    ipDownloads?: {
      downloadCount: number;
      remainingDownloads: number;
      resetTime?: number;
    };
  };
  ipLimited?: boolean;
}

export default function InstagramPostDownloadPage() {
  const currentLocale = useCurrentLocale() || 'zh-CN';
  const t = useI18n();
  const searchParams = useSearchParams();
  const { isAuthenticated } = useOptionalAuth();
  const { toast, dismiss } = useToast();
  const [url, setUrl] = useState('');
  const [loading, setLoading] = useState(false);
  const [downloadingItems, setDownloadingItems] = useState<Set<string>>(new Set());
  const [result, setResult] = useState<DownloadResult | null>(null);
  const [imageModalOpen, setImageModalOpen] = useState(false);
  const [selectedImage, setSelectedImage] = useState<{src: string; alt: string} | null>(null);
  const [videoModalOpen, setVideoModalOpen] = useState(false);
  const [selectedVideo, setSelectedVideo] = useState<{src: string; title: string} | null>(null);
  const [premiumModalOpen, setPremiumModalOpen] = useState(false);
  const [ipLimitModalOpen, setIpLimitModalOpen] = useState(false);
  const inputRef = useRef<HTMLInputElement>(null);
  const resultsRef = useRef<HTMLDivElement>(null);
  const [autoSubmitted, setAutoSubmitted] = useState(false);
  const [showLoadingPrompt, setShowLoadingPrompt] = useState(false);

  // Ê£ÄÊü•URLÂèÇÊï∞Âπ∂Ëá™Âä®Â°´ÂÖÖÂíåÊèê‰∫§
  useEffect(() => {
    const urlParam = searchParams?.get('url');
    if (urlParam && !autoSubmitted) {
      setUrl(urlParam);
      setAutoSubmitted(true);
      // Âª∂ËøüÊèê‰∫§ÔºåËÆ©UIÂÖàÊ∏≤Êüì
      setTimeout(() => {
        handleAutoSubmit(urlParam);
      }, 100);
    }
  }, [searchParams, autoSubmitted]);

  // ÊªöÂä®Âà∞ÁªìÊûúÂå∫Âüü
  const scrollToResults = () => {
    if (resultsRef.current) {
      resultsRef.current.scrollIntoView({ 
        behavior: 'smooth',
        block: 'start'
      });
    }
  };

  const handleAutoSubmit = async (autoUrl: string) => {
    if (!autoUrl.trim()) return;

    setLoading(true);
    setResult(null);
    // Â¶ÇÊûúÊòØÊú™ÁôªÂΩïÁî®Êà∑ÔºåÁ´ãÂç≥ÊòæÁ§∫Ê≥®ÂÜåÊèêÁ§∫
    if (!isAuthenticated) {
      setShowLoadingPrompt(true);
    }

    try {
      const response = await fetch('/api/instagram/download', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ 
          url: autoUrl.trim(),
          quality: isAuthenticated ? 'original' : 'hd'  // ÁôªÂΩïÁî®Êà∑ËØ∑Ê±ÇÂéüÂõæÔºåÊú™ÁôªÂΩïÁî®Êà∑ÈôêÂà∂‰∏∫HD
        }),
      });

      const data: DownloadResult = await response.json();
      
      // Â¶ÇÊûúÊòØÊ¨°Êï∞‰∏çË∂≥ÈîôËØØÔºåÊòæÁ§∫ÂçáÁ∫ßÊ®°ÊÄÅÊ°Ü
      if (!data.success && data.needsUpgrade) {
        setPremiumModalOpen(true);
        setLoading(false);
        return;
      }
      
      // Â¶ÇÊûúÊòØIPÈôêÂà∂ÈîôËØØÔºåÊòæÁ§∫IPÈôêÂà∂ÂºπÁ™ó
      if (!data.success && data.ipLimited) {
        setIpLimitModalOpen(true);
        setLoading(false);
        return;
      }
      
      setResult(data);
      
      // Êó†ËÆ∫ÊàêÂäüÊàñÂ§±Ë¥•ÔºåÈÉΩÊªöÂä®Âà∞ÁªìÊûúÂå∫Âüü
      setTimeout(() => {
        scrollToResults();
      }, 100);
      
      if (!data.success) {
        console.error('‰∏ãËΩΩÂ§±Ë¥•:', data.error);
      } else if (data.meta?.usageDeducted) {
        console.log('Ëá™Âä®‰∏ãËΩΩÊàêÂäüÔºåÂ∑≤Êâ£Èô§1Ê¨°‰∏ãËΩΩÊ¨°Êï∞ÔºåÂâ©‰Ωô:', data.meta.remainingUsage);
      }
    } catch (error) {
      console.error('APIËØ∑Ê±ÇÂ§±Ë¥•:', error);
      setResult({
        success: false,
        error: error instanceof Error ? error.message : t('errors.networkError')
      });
    } finally {
      setLoading(false);
      setShowLoadingPrompt(false);
    }
  };

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    
    if (!url.trim()) {
      setResult({
        success: false,
        error: t('download.form.urlRequired')
      });
      return;
    }

    setLoading(true);
    setResult(null);
    // Â¶ÇÊûúÊòØÊú™ÁôªÂΩïÁî®Êà∑ÔºåÁ´ãÂç≥ÊòæÁ§∫Ê≥®ÂÜåÊèêÁ§∫
    if (!isAuthenticated) {
      setShowLoadingPrompt(true);
    }

    try {
      const response = await fetch('/api/instagram/download', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ 
          url: url.trim(),
          quality: isAuthenticated ? 'original' : 'hd'  // ÁôªÂΩïÁî®Êà∑ËØ∑Ê±ÇÂéüÂõæÔºåÊú™ÁôªÂΩïÁî®Êà∑ÈôêÂà∂‰∏∫HD
        }),
      });

      const data: DownloadResult = await response.json();
      
      // Â¶ÇÊûúÊòØÊ¨°Êï∞‰∏çË∂≥ÈîôËØØÔºåÊòæÁ§∫ÂçáÁ∫ßÊ®°ÊÄÅÊ°Ü
      if (!data.success && data.needsUpgrade) {
        setPremiumModalOpen(true);
        setLoading(false);
        return;
      }
      
      // Â¶ÇÊûúÊòØIPÈôêÂà∂ÈîôËØØÔºåÊòæÁ§∫IPÈôêÂà∂ÂºπÁ™ó
      if (!data.success && data.ipLimited) {
        setIpLimitModalOpen(true);
        setLoading(false);
        return;
      }
      
      setResult(data);
      
      // Êó†ËÆ∫ÊàêÂäüÊàñÂ§±Ë¥•ÔºåÈÉΩÊªöÂä®Âà∞ÁªìÊûúÂå∫Âüü
      setTimeout(() => {
        scrollToResults();
      }, 100);
      
      if (!data.success) {
        console.error('‰∏ãËΩΩÂ§±Ë¥•:', data.error);
      } else if (data.meta?.usageDeducted) {
        console.log('‰∏ãËΩΩÊàêÂäüÔºåÂ∑≤Êâ£Èô§1Ê¨°‰∏ãËΩΩÊ¨°Êï∞ÔºåÂâ©‰Ωô:', data.meta.remainingUsage);
      }
    } catch (error) {
      console.error('APIËØ∑Ê±ÇÂ§±Ë¥•:', error);
      setResult({
        success: false,
        error: error instanceof Error ? error.message : t('errors.networkError')
      });
    } finally {
      setLoading(false);
      setShowLoadingPrompt(false);
    }
  };

  const handleClear = () => {
    setUrl('');
    setResult(null);
    inputRef.current?.focus();
  };

  const handleCopyUrl = async () => {
    try {
      // ÁîüÊàê‰∏ãËΩΩÈ°µÈù¢ÈìæÊé•Ôºå‰ΩøÁî®ÂéüÂßãInstagram URL
      const downloadPageUrl = `${window.location.origin}/${currentLocale}/download/post?url=${encodeURIComponent(url)}`;
      await navigator.clipboard.writeText(downloadPageUrl);
      toast.success('ÈìæÊé•Â∑≤Â§çÂà∂', '‰∏ãËΩΩÈìæÊé•Â∑≤Â§çÂà∂Âà∞Ââ™Ë¥¥Êùø');
      console.log('Â§çÂà∂ÁöÑÈìæÊé•:', downloadPageUrl);
    } catch (error) {
      console.error('Â§çÂà∂Â§±Ë¥•:', error);
      toast.error('Â§çÂà∂Â§±Ë¥•', 'Êó†Ê≥ïÂ§çÂà∂ÈìæÊé•Âà∞Ââ™Ë¥¥Êùø');
    }
  };

  // Â§ÑÁêÜÂ™í‰ΩìÁÇπÂáªÈ¢ÑËßàÔºàÊîØÊåÅÂõæÁâáÂíåËßÜÈ¢ëÔºâ
  const handleMediaClick = (src: string, alt: string, isVideo: boolean = false) => {
    console.log('üñ±Ô∏è handleMediaClick Ë¢´Ë∞ÉÁî®:', { src: src?.substring(0, 100), alt, isVideo });
    
    if (isVideo) {
      console.log('üé¨ Ê£ÄÊµãÂà∞ËßÜÈ¢ëÔºåÊâìÂºÄËßÜÈ¢ëÊ®°ÊÄÅÊ°Ü');
      // ÂØπ‰∫éËßÜÈ¢ëÔºåÁõ¥Êé•‰ΩøÁî®srcÔºàÂ∑≤ÁªèÊòØÊ≠£Á°ÆÁöÑ‰ª£ÁêÜURLÔºâ
      setSelectedVideo({ src: src, title: alt });
      setVideoModalOpen(true);
      return;
    }
    console.log('üñºÔ∏è Ê£ÄÊµãÂà∞ÂõæÁâáÔºåÊâìÂºÄÂõæÁâáÊ®°ÊÄÅÊ°Ü');
    // Âè™ÊúâÂõæÁâáÊâç‰ΩøÁî®ImageÁªÑ‰ª∂ÁöÑÊ®°ÊÄÅÊ°Ü
    setSelectedImage({ src, alt });
    setImageModalOpen(true);
  };

  // Â§ÑÁêÜÁõ¥Êé•‰∏ãËΩΩ
  const handleDirectDownload = async (url: string, filename?: string) => {
    // Èò≤Ê≠¢ÈáçÂ§çÁÇπÂáª
    const downloadKey = `${url}-${filename}`;
    if (downloadingItems.has(downloadKey)) {
      toast.warning('Ê≠£Âú®‰∏ãËΩΩ‰∏≠', 'ËØ∑Á≠âÂæÖÂΩìÂâç‰∏ãËΩΩÂÆåÊàê');
      return;
    }
    
    // Ê∑ªÂä†Âà∞‰∏ãËΩΩ‰∏≠ÈõÜÂêà
    setDownloadingItems(prev => new Set(prev).add(downloadKey));
    
    // Âà§Êñ≠Â™í‰ΩìÁ±ªÂûã
    const isVideo = url.includes('video') || filename?.includes('video') || filename?.includes('.mp4');
    const mediaType = isVideo ? 'ËßÜÈ¢ë' : 'ÂõæÁâá';
    
    // ÊòæÁ§∫‰∏ãËΩΩÂºÄÂßãÊèêÁ§∫
    const loadingId = toast.loading(`Ê≠£Âú®‰∏ãËΩΩ${mediaType}`, `Ê≠£Âú®Â§ÑÁêÜÊÇ®ÁöÑ‰∏ãËΩΩËØ∑Ê±Ç...`);
    
    try {
      // ÂàõÂª∫‰∏ãËΩΩÈìæÊé•
      const link = document.createElement('a');
      link.href = url;
      link.download = filename || 'instagram-media';
      link.target = '_blank';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      
      // ‰∏ãËΩΩÊàêÂäüÊèêÁ§∫
      setTimeout(() => {
        dismiss(loadingId);
        toast.success('ÂºÄÂßã‰∏ãËΩΩÔºÅ', `${mediaType}Ê≠£Âú®‰∏ãËΩΩÂà∞ÊÇ®ÁöÑËÆæÂ§á`);
      }, 500);
    } catch (error) {
      console.error('‰∏ãËΩΩÂ§±Ë¥•:', error);
      dismiss(loadingId);
      toast.error('‰∏ãËΩΩÂ§±Ë¥•', 'ËØ∑Á®çÂêéÈáçËØïÊàñÂ∞ùËØïÂÖ∂‰ªñÂàÜËæ®Áéá');
    } finally {
      // 3ÁßíÂêé‰ªé‰∏ãËΩΩ‰∏≠ÈõÜÂêàÁßªÈô§
      setTimeout(() => {
        setDownloadingItems(prev => {
          const newSet = new Set(prev);
          newSet.delete(downloadKey);
          return newSet;
        });
      }, 3000);
    }
  };

  // Â§ÑÁêÜVIPÂçáÁ∫ßÊ®°ÊÄÅÊ°ÜÊìç‰Ωú
  const handlePremiumSignUp = () => {
    setPremiumModalOpen(false);
    // Ë∑≥ËΩ¨Âà∞Ê≥®ÂÜåÈ°µÈù¢
    window.location.href = `/${currentLocale}/signin?tab=register`;
  };

  const handlePremiumLogin = () => {
    setPremiumModalOpen(false);
    // Ë∑≥ËΩ¨Âà∞ÁôªÂΩïÈ°µÈù¢
    window.location.href = `/${currentLocale}/signin`;
  };

  // Â§ÑÁêÜIPÈôêÂà∂ÂºπÁ™óÊìç‰Ωú
  const handleIpLimitRegister = () => {
    setIpLimitModalOpen(false);
    // Ë∑≥ËΩ¨Âà∞Ê≥®ÂÜåÈ°µÈù¢
    window.location.href = `/${currentLocale}/signin?tab=register`;
  };

  const handleIpLimitLogin = () => {
    setIpLimitModalOpen(false);
    // Ë∑≥ËΩ¨Âà∞ÁôªÂΩïÈ°µÈù¢
    window.location.href = `/${currentLocale}/signin`;
  };

  // Â§ÑÁêÜÈîÆÁõò‰∫ã‰ª∂ÔºàEscape ÈîÆÂÖ≥Èó≠Ê®°ÊÄÅÊ°ÜÔºâ
  useEffect(() => {
    const handleKeyDown = (event: KeyboardEvent) => {
      if (event.key === 'Escape') {
        if (imageModalOpen) {
          setImageModalOpen(false);
          setSelectedImage(null);
        }
        if (videoModalOpen) {
          setVideoModalOpen(false);
          setSelectedVideo(null);
        }
      }
    };

    if (imageModalOpen || videoModalOpen) {
      document.addEventListener('keydown', handleKeyDown);
      document.body.style.overflow = 'hidden'; // Èò≤Ê≠¢ËÉåÊôØÊªöÂä®
    }

    return () => {
      document.removeEventListener('keydown', handleKeyDown);
      document.body.style.overflow = 'unset'; // ÊÅ¢Â§çÊªöÂä®
    };
  }, [imageModalOpen, videoModalOpen]);

  return (
    <div className="min-h-screen bg-gradient-to-br from-blue-50 via-indigo-50 to-purple-50">
      <div className="container mx-auto px-4 py-8">
        {/* Èù¢ÂåÖÂ±ëÂØºËà™ */}
        <nav className="text-sm mb-8">
          <Link href={`/${currentLocale}`} className="text-blue-600 hover:underline">{t('nav.home')}</Link>
          <span className="mx-2 text-gray-400">/</span>
          <Link href={`/${currentLocale}/download`} className="text-blue-600 hover:underline">{t('downloadCenter.title')}</Link>
          <span className="mx-2 text-gray-400">/</span>
          <span className="text-gray-600">{t('downloadPages.post.title')}</span>
        </nav>

        {/* ËøîÂõûÊåâÈíÆ */}
        <Link href={`/${currentLocale}/download`}>
          <Button variant="outline" className="mb-8">
            <ArrowLeft className="w-4 h-4 mr-2" />
            {t('common.back')} {t('downloadCenter.title')}
          </Button>
        </Link>

        {/* ‰∏ªÂÜÖÂÆπÂå∫Âüü */}
        <motion.div
          className="max-w-4xl mx-auto"
          initial={{ opacity: 0, y: 20 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ duration: 0.6 }}
        >
          {/* È°µÈù¢Ê†áÈ¢ò */}
          <div className="text-center mb-12">
            <motion.div 
              className="flex justify-center mb-6"
              initial={{ scale: 0 }}
              animate={{ scale: 1 }}
              transition={{ duration: 0.5 }}
            >
              <div className="p-4 bg-gradient-to-r from-blue-500 to-purple-500 rounded-full">
                <Instagram className="w-8 h-8 text-white" />
              </div>
            </motion.div>
            
            <h1 className="text-4xl md:text-5xl font-bold mb-4 bg-gradient-to-r from-gray-900 via-blue-900 to-purple-900 bg-clip-text text-transparent">
              {t('downloadPages.post.heading')}
            </h1>
            
            <p className="text-xl text-gray-600 mb-8">
              {t('downloadPages.post.subheading')}
            </p>
          </div>

          {/* ‰∏ãËΩΩË°®Âçï */}
          <Card className="bg-white/80 backdrop-blur-sm border-0 shadow-xl mb-8">
            <CardHeader>
              <CardTitle className="flex items-center gap-2 text-xl">
                <LinkIcon className="w-5 h-5" />
                {t('download.form.urlLabel')}
              </CardTitle>
            </CardHeader>
            <CardContent>
              <form onSubmit={handleSubmit} className="space-y-4">
                <div className="flex gap-4">
                  <Input
                    ref={inputRef}
                    type="url"
                    placeholder={t('downloadPages.post.inputPlaceholder')}
                    value={url}
                    onChange={(e) => setUrl(e.target.value)}
                    className="flex-1"
                    disabled={loading}
                  />
                  <Button
                    type="button"
                    variant="outline"
                    onClick={handleClear}
                    disabled={loading || !url}
                  >
                    {t('common.cancel')}
                  </Button>
                </div>
                
                <div className="flex gap-4">
                  <Button
                    type="submit"
                    disabled={loading || !url.trim()}
                    className="flex-1 bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700"
                    size="lg"
                  >
                    {loading ? (
                      <>
                        <Loader2 className="w-5 h-5 mr-2 animate-spin" />
                        {t('download.form.downloading')}
                      </>
                    ) : (
                      <>
                        <Download className="w-5 h-5 mr-2" />
                        {t('download.form.startDownload')}
                      </>
                    )}
                  </Button>
                </div>
              </form>

              {/* ‰∏ãËΩΩ‰∏≠ÁöÑÊ≥®ÂÜåÊèêÁ§∫ - Á´ãÂç≥ÊòæÁ§∫ */}
              {showLoadingPrompt && !isAuthenticated && (
                <motion.div 
                  className="mt-4 p-4 bg-gradient-to-r from-orange-50 to-red-50 rounded-lg border-2 border-orange-200 shadow-lg"
                  initial={{ opacity: 0, y: -10 }}
                  animate={{ opacity: 1, y: 0 }}
                  transition={{ duration: 0.5 }}
                >
                  <div className="flex items-center gap-3 mb-3">
                    <div className="w-8 h-8 bg-gradient-to-r from-orange-400 to-red-400 rounded-full flex items-center justify-center">
                      <span className="text-white text-lg">‚ö°</span>
                    </div>
                    <div>
                      <h4 className="font-bold text-orange-800 text-lg">Ê≠£Âú®‰∏∫ÊÇ®Ëß£ÊûêÂÜÖÂÆπ...</h4>
                      <p className="text-orange-700 text-sm">ÂÖçË¥πÁî®Êà∑ÈúÄË¶ÅÁ≠âÂæÖÔºåÊ≥®ÂÜå‰ºöÂëòÁ´ãÂç≥‰∫´ÂèóÊûÅÈÄü‰∏ãËΩΩÔºÅ</p>
                    </div>
                  </div>
                  
                  <div className="bg-white/80 rounded-lg p-3 mb-3">
                    <h5 className="font-semibold text-gray-800 mb-2 flex items-center gap-2">
                      <span className="text-yellow-500">üëë</span>
                      ÂçáÁ∫ßVIP‰ºöÂëòÔºåËß£ÈîÅÂÖ®ÈÉ®ÁâπÊùÉÔºö
                    </h5>
                    <ul className="text-sm text-gray-700 space-y-1">
                      <li className="flex items-center gap-2">
                        <span className="text-green-500">‚úì</span>
                        <strong>ÁßíÈÄü‰∏ãËΩΩ</strong> - Êó†‰ªª‰ΩïÁ≠âÂæÖÊó∂Èó¥
                      </li>
                      <li className="flex items-center gap-2">
                        <span className="text-green-500">‚úì</span>
                        <strong>ÂéüÂõæÁîªË¥®</strong> - ÊúÄÈ´òÂàÜËæ®ÁéáÔºåÂÆåÁæéÁîªË¥®
                      </li>
                      <li className="flex items-center gap-2">
                        <span className="text-green-500">‚úì</span>
                        <strong>Êó†Èôê‰∏ãËΩΩ</strong> - ÊØèÊúà500Ê¨°‰∏ãËΩΩÈ¢ùÂ∫¶
                      </li>
                      <li className="flex items-center gap-2">
                        <span className="text-green-500">‚úì</span>
                        <strong>ÊâπÈáè‰∏ãËΩΩ</strong> - ‰∏ÄÈîÆ‰∏ãËΩΩÂ§ö‰∏™ÂÜÖÂÆπ
                      </li>
                    </ul>
                  </div>
                  
                  <div className="flex gap-3">
                    <Button 
                      className="flex-1 bg-gradient-to-r from-orange-500 to-red-500 hover:from-orange-600 hover:to-red-600 text-white font-semibold shadow-lg"
                      onClick={() => window.location.href = `/${currentLocale}/signin?tab=register`}
                    >
                      <span className="mr-2">üöÄ</span>
                      Á´ãÂç≥Ê≥®ÂÜåVIP
                    </Button>
                    <Button 
                      variant="outline" 
                      className="flex-1 border-orange-300 text-orange-700 hover:bg-orange-50"
                      onClick={() => window.location.href = `/${currentLocale}/signin`}
                    >
                      Â∑≤ÊúâË¥¶Êà∑ÔºüÁôªÂΩï
                    </Button>
                  </div>
                  
                  <div className="mt-3 text-center">
                    <p className="text-xs text-gray-500">
                      üí∞ ÈôêÊó∂‰ºòÊÉ†ÔºöÈ¶ñÊúà‰ªÖÈúÄ ¬•9.9ÔºåÁ´ãÁúÅ ¬•20
                    </p>
                  </div>
                </motion.div>
              )}

              {/* Áî®Êà∑‰∏ãËΩΩÊ¨°Êï∞Áä∂ÊÄÅ */}
              {isAuthenticated && result?.meta && (
                <div className="mt-4 p-3 bg-blue-50 rounded-lg border border-blue-200">
                  <div className="flex items-center justify-between text-sm">
                    <span className="text-blue-700 font-medium">
                      Ââ©‰Ωô‰∏ãËΩΩÊ¨°Êï∞Ôºö
                    </span>
                    <span className="text-blue-800 font-bold">
                      {result.meta.remainingUsage || 0}
                    </span>
                  </div>
                  {result.meta.usageDeducted && (
                    <p className="text-blue-600 text-xs mt-1">
                      ‚úÖ Êú¨Ê¨°‰∏ãËΩΩÂ∑≤Êâ£Èô§1Ê¨°ÔºåÂâ©‰Ωô {result.meta.remainingUsage} Ê¨°
                    </p>
                  )}
                </div>
              )}
              {/* Á§∫‰æãÈìæÊé• */}
              <div className="mt-6 p-4 bg-gray-50 rounded-lg">
                <p className="text-sm text-gray-600 mb-2">
                  <strong>{t('download.form.supportedTypes')}</strong>
                </p>
                <ul className="text-sm text-gray-500 space-y-1">
                  <li>‚Ä¢ https://www.instagram.com/p/ABC123...</li>
                  <li>‚Ä¢ https://instagram.com/p/ABC123...</li>
                  <li>‚Ä¢ https://instagr.am/p/ABC123...</li>
                </ul>
              </div>
            </CardContent>
          </Card>

          {/* ÁªìÊûúÊòæÁ§∫ */}
          {result && (
            <motion.div
              ref={resultsRef}
              initial={{ opacity: 0, y: 20 }}
              animate={{ opacity: 1, y: 0 }}
              transition={{ duration: 0.5 }}
            >
              {result.success ? (
                <Card className="bg-gradient-to-br from-green-50 to-emerald-50 border-green-200 shadow-lg mb-8">
                  <CardHeader>
                    <CardTitle className="flex items-center gap-2 text-green-800">
                      <CheckCircle className="w-5 h-5" />
                      {t('download.result.completed')}
                    </CardTitle>
                  </CardHeader>
                  <CardContent>
                    {result.data && (result.data.media?.length > 0 || result.data.url) ? (
                      <div className="space-y-6">
                        {/* Áî®Êà∑‰ø°ÊÅØÂíåÊ†áÈ¢ò */}
                        {result.data.username && (
                          <div className="flex items-center gap-3 p-4 bg-white/80 rounded-lg">
                            <div className="w-12 h-12 bg-gradient-to-br from-purple-400 to-pink-400 rounded-full flex items-center justify-center">
                              <Instagram className="w-6 h-6 text-white" />
                            </div>
                            <div>
                              <h4 className="font-semibold text-gray-800">@{result.data.username}</h4>
                              {result.data.caption && (
                                <p className="text-sm text-gray-600 truncate max-w-md">{result.data.caption}</p>
                              )}
                            </div>
                            {result._mode && (
                              <div className="ml-auto">
                                <span className="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded-full">
                                  {result._mode.includes('mock') ? 'ÊºîÁ§∫Êï∞ÊçÆ' : 'ÁúüÂÆûÊï∞ÊçÆ'}
                                </span>
                              </div>
                            )}
                          </div>
                        )}

                        {/* ÂõæÁâáÁîªÂªäÁΩëÊ†º */}
                        <div>
                          <h4 className="text-lg font-semibold mb-4 text-gray-800 flex items-center gap-2">
                            <ImageIcon className="w-5 h-5" />
                            {t('download.result.selectResolution')}
                          </h4>
                          
                          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            {/* ‰ΩøÁî®Êàë‰ª¨Êñ∞ÁöÑÂ™í‰ΩìÊï∞ÁªÑÁªìÊûÑ */}
                            {result.data.media?.map((media, index) => (
                              <MediaCard 
                                key={media.id || index}
                                media={media}
                                index={index}
                                isAuthenticated={isAuthenticated}
                                isDownloading={downloadingItems.has(`${media.is_video ? media.video_url : media.url}-instagram-${media.id || index}-${media.is_video ? 'video' : `${media.display_resources?.[0]?.config_width}x${media.display_resources?.[0]?.config_height}`}.${media.is_video ? 'mp4' : 'jpg'}`)}
                                onImageClick={handleMediaClick}
                                onDirectDownload={handleDirectDownload}
                                onCopyUrl={handleCopyUrl}
                                onPremiumUpgrade={() => setPremiumModalOpen(true)}
                                t={t}
                              />
                            ))}
                          </div>
                        </div>

                        {/* ‰∏ãËΩΩÁªüËÆ°‰ø°ÊÅØ */}
                        {result.downloads && result.downloads.length > 0 && (
                          <div className="mt-8">
                            <div className="p-4 bg-blue-50 rounded-lg border border-blue-200">
                              <h4 className="text-lg font-semibold mb-2 text-blue-900 flex items-center gap-2">
                                <Download className="w-5 h-5" />
                                {t('download.result.mediaDownload')}
                              </h4>
                              <div className="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                                <div>
                                  <span className="text-blue-600 font-medium">{t('download.result.mediaFiles')}Ôºö</span>
                                  <span className="text-blue-800">{result.downloads.length} ‰∏™</span>
                                </div>
                                <div>
                                  <span className="text-blue-600 font-medium">{t('download.result.image')}Ôºö</span>
                                  <span className="text-blue-800">{result.downloads.filter(d => d.type === 'image').length} ‰∏™</span>
                                </div>
                                <div>
                                  <span className="text-blue-600 font-medium">{t('download.result.video')}Ôºö</span>
                                  <span className="text-blue-800">{result.downloads.filter(d => d.type === 'video').length} ‰∏™</span>
                                </div>
                                <div>
                                  <span className="text-blue-600 font-medium">{t('download.result.totalSize')}Ôºö</span>
                                  <span className="text-blue-800">
                                    {(result.downloads.reduce((acc, d) => acc + (d.resolutions?.[0]?.size || 0), 0) / 1024 / 1024).toFixed(2)} MB
                                  </span>
                                </div>
                              </div>
                            </div>
                          </div>
                        )}
                      </div>
                    ) : (
                      <Alert>
                        <AlertCircle className="h-4 w-4" />
                        <AlertDescription>
                          {t('download.result.downloadFailed')}
                        </AlertDescription>
                      </Alert>
                    )}
                  </CardContent>
                </Card>
              ) : (
                <Alert variant="destructive" className="mb-8">
                  <AlertCircle className="h-4 w-4" />
                  <AlertDescription>
                    {typeof result.error === 'string' 
                      ? result.error 
                      : (result.error as any)?.message || (result.error as any)?.toString() || t('download.form.downloadFailed')
                    }
                  </AlertDescription>
                </Alert>
              )}
            </motion.div>
          )}
        </motion.div>

        {/* ‰ΩøÁî®Ê≠•È™§ */}
        <section className="mb-16">
          <h2 className="text-3xl font-bold text-center text-gray-900 mb-12">
            {t('downloadPages.post.howToUse')}
          </h2>
          <div className="grid md:grid-cols-3 gap-8 max-w-5xl mx-auto">
            <div className="text-center">
              <div className="w-16 h-16 bg-purple-600 text-white rounded-full flex items-center justify-center text-xl font-bold mx-auto mb-4">
                1
              </div>
              <h3 className="text-xl font-semibold text-gray-900 mb-2">
                {t('download.step1')}
              </h3>
              <p className="text-gray-600">
                {t('download.step1')}
              </p>
            </div>
            <div className="text-center">
              <div className="w-16 h-16 bg-purple-600 text-white rounded-full flex items-center justify-center text-xl font-bold mx-auto mb-4">
                2
              </div>
              <h3 className="text-xl font-semibold text-gray-900 mb-2">
                {t('download.step2')}
              </h3>
              <p className="text-gray-600">
                {t('download.step2')}
              </p>
            </div>
            <div className="text-center">
              <div className="w-16 h-16 bg-purple-600 text-white rounded-full flex items-center justify-center text-xl font-bold mx-auto mb-4">
                3
              </div>
              <h3 className="text-xl font-semibold text-gray-900 mb-2">
                {t('download.step3')}
              </h3>
              <p className="text-gray-600">
                {t('download.step4')}
              </p>
            </div>
          </div>
        </section>

        {/* ÂäüËÉΩÁâπËâ≤ */}
        <section className="mb-16">
          <h2 className="text-3xl font-bold text-center text-gray-900 mb-12">
            {t('download.features.title')}
          </h2>
          <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-6 max-w-6xl mx-auto">
            <div className="bg-white rounded-lg p-6 shadow-sm border">
              <div className="w-8 h-8 text-green-500 mb-3">‚úì</div>
              <h3 className="font-semibold text-gray-900 mb-2">{t('download.features.highQuality')}</h3>
              <p className="text-gray-600 text-sm">
                {t('download.features.highQualityDesc')}
              </p>
            </div>
            <div className="bg-white rounded-lg p-6 shadow-sm border">
              <div className="w-8 h-8 text-green-500 mb-3">‚úì</div>
              <h3 className="font-semibold text-gray-900 mb-2">{t('download.features.noWatermark')}</h3>
              <p className="text-gray-600 text-sm">
                {t('download.features.noWatermarkDesc')}
              </p>
            </div>
            <div className="bg-white rounded-lg p-6 shadow-sm border">
              <div className="w-8 h-8 text-green-500 mb-3">‚úì</div>
              <h3 className="font-semibold text-gray-900 mb-2">{t('download.features.fastSpeed')}</h3>
              <p className="text-gray-600 text-sm">
                {t('download.features.fastSpeedDesc')}
              </p>
            </div>
            <div className="bg-white rounded-lg p-6 shadow-sm border">
              <div className="w-8 h-8 text-green-500 mb-3">‚úì</div>
              <h3 className="font-semibold text-gray-900 mb-2">ÂÖçË¥π‰ΩøÁî®</h3>
              <p className="text-gray-600 text-sm">
                ÂÆåÂÖ®ÂÖçË¥πÁöÑÊúçÂä°ÔºåÊó†ÈúÄÊ≥®ÂÜåÊàñ‰ªòË¥πÂç≥ÂèØ‰ΩøÁî®„ÄÇ
              </p>
            </div>
            <div className="bg-white rounded-lg p-6 shadow-sm border">
              <div className="w-8 h-8 text-green-500 mb-3">‚úì</div>
              <h3 className="font-semibold text-gray-900 mb-2">ÈöêÁßÅ‰øùÊä§</h3>
              <p className="text-gray-600 text-sm">
                ‰∏ç‰øùÂ≠òÁî®Êà∑Êï∞ÊçÆÔºå‰øùÊä§ÊÇ®ÁöÑÈöêÁßÅÂíåÂÆâÂÖ®„ÄÇ
              </p>
            </div>
            <div className="bg-white rounded-lg p-6 shadow-sm border">
              <div className="w-8 h-8 text-green-500 mb-3">‚úì</div>
              <h3 className="font-semibold text-gray-900 mb-2">Ë∑®Âπ≥Âè∞ÊîØÊåÅ</h3>
              <p className="text-gray-600 text-sm">
                ÊîØÊåÅÊâÄÊúâËÆæÂ§áÂíåÊµèËßàÂô®ÔºåÈöèÊó∂ÈöèÂú∞‰ΩøÁî®„ÄÇ
              </p>
            </div>
          </div>
        </section>
      </div>

      {/* ÂõæÁâáÊîæÂ§ßÊ®°ÊÄÅÊ°Ü */}
      {imageModalOpen && selectedImage && (
        <motion.div
          className="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm"
          initial={{ opacity: 0 }}
          animate={{ opacity: 1 }}
          exit={{ opacity: 0 }}
          onClick={() => {
            setImageModalOpen(false);
            setSelectedImage(null);
          }}
        >
          <motion.div
            className="relative max-w-4xl max-h-[90vh] mx-4"
            initial={{ scale: 0.8, opacity: 0 }}
            animate={{ scale: 1, opacity: 1 }}
            exit={{ scale: 0.8, opacity: 0 }}
            transition={{ type: "spring", damping: 25, stiffness: 300 }}
            onClick={(e) => e.stopPropagation()} // Èò≤Ê≠¢ÁÇπÂáªÂõæÁâáÊó∂ÂÖ≥Èó≠Ê®°ÊÄÅÊ°Ü
          >
            {/* ÂÖ≥Èó≠ÊåâÈíÆ */}
            <Button
              variant="secondary"
              size="sm"
              className="absolute -top-12 right-0 bg-white/90 hover:bg-white text-gray-800 shadow-lg z-10"
              onClick={() => {
                setImageModalOpen(false);
                setSelectedImage(null);
              }}
            >
              <X className="w-4 h-4" />
            </Button>

            {/* ÂõæÁâáÂÆπÂô® */}
            <div className="bg-white rounded-lg shadow-2xl overflow-hidden">
              <Image
                src={selectedImage.src}
                alt={selectedImage.alt}
                width={800}
                height={600}
                className="w-full h-auto max-h-[80vh] object-contain"
                onError={(e) => {
                  const target = e.target as HTMLImageElement;
                  target.src = generatePlaceholder(800, 600, 'ÂõæÁâáÂä†ËΩΩÂ§±Ë¥•');
                }}
              />
              
              {/* ÂõæÁâá‰ø°ÊÅØÂíåÊìç‰ΩúÊ†è */}
              <div className="p-4 bg-white">
                <div className="flex items-center justify-between">
                  <div>
                    <h3 className="font-semibold text-gray-800 mb-1">
                      {selectedImage.alt}
                    </h3>
                    <p className="text-sm text-gray-500">
                      ÁÇπÂáªÂõæÁâáÂ§ñÈÉ®Âå∫ÂüüÊàñÊåâ ESC ÈîÆÂÖ≥Èó≠
                    </p>
                  </div>
                  <div className="flex gap-2">
                    <Button
                      size="sm"
                      className="bg-green-600 hover:bg-green-700"
                      onClick={() => handleDirectDownload(selectedImage.src, selectedImage.alt)}
                    >
                      <Download className="w-4 h-4 mr-1" />
                      {t('common.download')}
                    </Button>
                    <Button
                      size="sm"
                      variant="outline"
                      onClick={() => handleCopyUrl()}
                    >
                      <Copy className="w-4 h-4 mr-1" />
                      {t('common.copy')}
                    </Button>
                  </div>
                </div>
              </div>
            </div>
          </motion.div>
        </motion.div>
      )}

      {/* ËßÜÈ¢ëÈ¢ÑËßàÊ®°ÊÄÅÊ°Ü */}
      {selectedVideo && (
        <VideoPreviewModal
          isOpen={videoModalOpen}
          onClose={() => {
            setVideoModalOpen(false);
            setSelectedVideo(null);
          }}
          videoSrc={selectedVideo.src}
          title={selectedVideo.title}
          onDownload={handleDirectDownload}
          onCopyUrl={handleCopyUrl}
        />
      )}

      {/* VIPÂçáÁ∫ßÊ®°ÊÄÅÊ°Ü */}
      <PremiumUpgradeModal
        isOpen={premiumModalOpen}
        onClose={() => setPremiumModalOpen(false)}
        onSignUp={handlePremiumSignUp}
        onLogin={handlePremiumLogin}
      />

      {/* IPÈôêÂà∂ÂºπÁ™ó */}
      <IPLimitModal
        isOpen={ipLimitModalOpen}
        onClose={() => setIpLimitModalOpen(false)}
        remainingHours={24}
        onRegister={handleIpLimitRegister}
        onLogin={handleIpLimitLogin}
      />
    </div>
  );
}

// Â™í‰ΩìÂç°ÁâáÁªÑ‰ª∂ - Ëß£ÂÜ≥ Hooks Âú®Âæ™ÁéØ‰∏≠‰ΩøÁî®ÁöÑÈóÆÈ¢ò
import { InstagramMedia, DisplayResource } from '@/types/instagram';

// Ëé∑ÂèñÂàÜËæ®ÁéáÊ†áÁ≠æÁöÑËæÖÂä©ÂáΩÊï∞
function getResolutionLabel(index: number, isAuthenticated: boolean, resource: DisplayResource, t: any): string {
  if (index === 0) {
    // Á¨¨‰∏Ä‰∏™ÈÄâÈ°πÔºàÂéüÂõæÔºâ
    return isAuthenticated ? t('download.result.original') : 'ÂéüÂõæ üîí';
  }
  
  // ÂÖ∂‰ªñÈÄâÈ°π
  if (index === 1) return '‰∏≠Á≠âË¥®Èáè';
  if (index === 2) return '‰ΩéË¥®Èáè';
  
  return resource.label || `${resource.config_width}√ó${resource.config_height}`;
}

interface MediaCardProps {
  media: InstagramMedia;
  index: number;
  isAuthenticated: boolean;
  isDownloading: boolean;
  onImageClick: (url: string, title: string, isVideo?: boolean) => void;
  onDirectDownload: (url: string, filename: string) => void;
  onCopyUrl: () => void;
  onPremiumUpgrade: () => void;
  t: any;
}

function MediaCard({ media, index, isAuthenticated, isDownloading, onImageClick, onDirectDownload, onCopyUrl, onPremiumUpgrade, t }: MediaCardProps) {
  // Â§ÑÁêÜÂàÜËæ®ÁéáÈÄâÊã©
  const handleResolutionClick = (resource: DisplayResource, resIndex: number) => {
    // Â¶ÇÊûúÊòØÂéüÂõæ‰∏îÁî®Êà∑Êú™ÁôªÂΩïÔºåÊòæÁ§∫VIPÂçáÁ∫ßÊ®°ÊÄÅÊ°Ü
    if (resIndex === 0 && !isAuthenticated) {
      onPremiumUpgrade();
      return;
    }
    
    // Ê≠£Â∏∏ÈÄâÊã©ÂàÜËæ®Áéá
    setSelectedResolution(resource);
  };
  // Ëé∑ÂèñÂàÜËæ®ÁéáÈÄâÈ°πÔºàÊú™ÁôªÂΩïÁî®Êà∑‰πüÊòæÁ§∫ÊâÄÊúâÈÄâÈ°πÔºåÁî®‰∫éÂºïÂØºÊ≥®ÂÜåÔºâ
  const getFilteredResolutions = () => {
    if (!media.display_resources || media.display_resources.length === 0) {
      return [];
    }
    
    // ÊâÄÊúâÁî®Êà∑ÈÉΩÊòæÁ§∫ÊâÄÊúâÂàÜËæ®ÁéáÈÄâÈ°π
    return media.display_resources;
  };

  const filteredResolutions = getFilteredResolutions();
  
  // Áä∂ÊÄÅÁÆ°ÁêÜÔºöÂΩìÂâçÈÄâ‰∏≠ÁöÑÂàÜËæ®Áéá
  const getDefaultResolution = () => {
    if (filteredResolutions.length === 0) return null;
    
    // Êú™ÁôªÂΩïÁî®Êà∑ÔºöÈªòËÆ§ÈÄâÊã©Á¨¨‰∫å‰∏™ÈÄâÈ°πÔºà‰∏≠Á≠âË¥®ÈáèÔºâ
    if (!isAuthenticated && filteredResolutions.length > 1) {
      return filteredResolutions[1];
    }
    
    // ÁôªÂΩïÁî®Êà∑ÔºöÈªòËÆ§ÈÄâÊã©Á¨¨‰∏Ä‰∏™ÈÄâÈ°πÔºàÂéüÂõæÔºâ
    return filteredResolutions[0];
  };
  
  const [selectedResolution, setSelectedResolution] = useState(getDefaultResolution());
  
  // Ëé∑ÂèñÂΩìÂâçÊòæÁ§∫ÁöÑURLÂíå‰ø°ÊÅØ
  const currentUrl = selectedResolution?.src || media.url;
  const currentWidth = selectedResolution?.config_width || media.width;
  const currentHeight = selectedResolution?.config_height || media.height;
  
  // Ëé∑ÂèñÂΩìÂâçÈÄâÊã©ÂàÜËæ®ÁéáÁöÑÊ†áÁ≠æ
  const getCurrentLabel = () => {
    if (!selectedResolution) return 'ÈªòËÆ§';
    
    const currentIndex = filteredResolutions.findIndex(res => res === selectedResolution);
    if (currentIndex === -1) return selectedResolution.label || 'ÈªòËÆ§';
    
    return getResolutionLabel(currentIndex, isAuthenticated, selectedResolution, t);
  };
  
  const currentLabel = getCurrentLabel();
  

  // Ë∞ÉËØïÊó•Âøó
  console.log('Media object:', {
    is_video: media.is_video,
    thumbnail: media.thumbnail,
    url: media.url,
    video_url: media.video_url,
    display_resources: media.display_resources?.length
  });

  // ÂØπ‰∫éËßÜÈ¢ëÔºåËé∑Âèñ‰∏ãËΩΩURLÂíåÈ¢ÑËßàURLÔºå‰ΩøÁî®Êô∫ËÉΩÂ™í‰Ωì‰ª£ÁêÜ
  // ‰ΩøÁî® SVG Âç†‰ΩçÁ¨¶Êõø‰ª£‰∏çÂ≠òÂú®ÁöÑÂõæÁâáÊñá‰ª∂
  const fallbackPlaceholder = generatePlaceholder(400, 400, media.is_video ? 'ËßÜÈ¢ëÈ¢ÑËßà' : 'ÂõæÁâáÂä†ËΩΩ‰∏≠');
  
  const previewUrl = media.is_video 
    ? (media.thumbnail // ËßÜÈ¢ë‰ΩøÁî® thumbnail Â≠óÊÆµ‰Ωú‰∏∫Áº©Áï•Âõæ
        ? generateImageSrc(media.thumbnail, fallbackPlaceholder)
        : media.url // Â¶ÇÊûúÊ≤°Êúâ thumbnailÔºåÂ∞ùËØï‰ΩøÁî® url
          ? generateImageSrc(media.url, fallbackPlaceholder)
          : fallbackPlaceholder) // ÊúÄÂêé‰ΩøÁî®Âç†‰ΩçÂõæ
    : generateImageSrc(currentUrl, fallbackPlaceholder); // ÂõæÁâáÁõ¥Êé•‰ΩøÁî®ÂΩìÂâçÈÄâÊã©ÁöÑÂàÜËæ®ÁéáURL
  
  console.log('Generated previewUrl:', previewUrl);
  const downloadUrl = media.is_video ? (media.video_url || currentUrl) : currentUrl; // ‰∏ãËΩΩ‰ΩøÁî®ËßÜÈ¢ëURLÊàñÂΩìÂâçÈÄâÊã©ÁöÑÂàÜËæ®Áéá
  
  return (
    <motion.div
      className="relative bg-white rounded-xl shadow-md hover:shadow-xl transition-all duration-300 overflow-hidden"
      whileHover={{ y: -5 }}
      initial={{ opacity: 0, y: 20 }}
      animate={{ opacity: 1, y: 0 }}
      transition={{ duration: 0.3, delay: 0.1 * index }}
    >
      <div className="aspect-square relative overflow-hidden">
        <Image
          src={previewUrl}
          alt={`Instagram Â™í‰Ωì ${index + 1}`}
          width={400}
          height={400}
          className="w-full h-full object-cover cursor-pointer transition-transform duration-300 hover:scale-105"
          onClick={() => {
            console.log('üñ±Ô∏è ÂõæÁâáÂç°ÁâáË¢´ÁÇπÂáª:', {
              is_video: media.is_video,
              downloadUrl,
              currentUrl,
              video_url: media.video_url,
              ‰º†ÈÄíÁªôonImageClickÁöÑURL: media.is_video ? downloadUrl : currentUrl
            });
            onImageClick(media.is_video ? downloadUrl : currentUrl, `Instagram Â™í‰Ωì ${index + 1}`, media.is_video);
          }}
          onError={(e) => {
            const target = e.target as HTMLImageElement;
            // ÈÅøÂÖçÊó†ÈôêÂæ™ÁéØÔºöÂè™Âú®‰∏çÊòØÂç†‰ΩçÁ¨¶ÁöÑÊÉÖÂÜµ‰∏ãËÆæÁΩÆÂç†‰ΩçÁ¨¶
            if (!target.src.startsWith('data:image/svg+xml')) {
              console.warn('ÂõæÁâáÂä†ËΩΩÂ§±Ë¥•Ôºå‰ΩøÁî®Âç†‰ΩçÁ¨¶:', target.src);
              target.src = generatePlaceholder(400, 400, 'Â™í‰ΩìÂä†ËΩΩÂ§±Ë¥•');
            }
          }}
        />
        {/* ËßÜÈ¢ëÊ†áËØÜ */}
        {media.is_video && (
          <div className="absolute top-2 left-2 bg-black/70 text-white px-2 py-1 rounded text-xs flex items-center gap-1">
            <Film className="w-3 h-3" />
            {t('download.result.video')}
          </div>
        )}
        {/* ÂõæÁâáÊ†áËØÜ */}
        {!media.is_video && (
          <div className="absolute top-2 left-2 bg-white/90 text-gray-800 px-2 py-1 rounded text-xs flex items-center gap-1">
            <ImageIcon className="w-3 h-3" />
            {t('download.result.image')}
          </div>
        )}
        {/* Â™í‰ΩìÂ∫èÂè∑ */}
        <div className="absolute bottom-2 left-2 bg-black/70 text-white px-2 py-1 rounded text-xs">
          #{index + 1}
        </div>
        
        {/* ËßÜÈ¢ëÊí≠ÊîæÊåâÈíÆË¶ÜÁõñÂ±Ç */}
        {media.is_video && (
          <div 
            className="absolute inset-0 flex items-center justify-center bg-black/20 opacity-0 hover:opacity-100 transition-opacity duration-300 cursor-pointer"
            onClick={() => {
              console.log('üñ±Ô∏è ËßÜÈ¢ëË¶ÜÁõñÂ±ÇË¢´ÁÇπÂáª:', {
                is_video: media.is_video,
                downloadUrl,
                video_url: media.video_url
              });
              onImageClick(downloadUrl, `Instagram Â™í‰Ωì ${index + 1}`, media.is_video);
            }}
          >
            <div className="w-16 h-16 bg-white/90 rounded-full flex items-center justify-center shadow-lg pointer-events-none">
              <Play className="w-8 h-8 text-gray-800 ml-1" />
            </div>
          </div>
        )}
      </div>
      
      <div className="p-4">
        
        {/* ÂàÜËæ®ÁéáÈÄâÊã©Âô® */}
        {filteredResolutions.length > 0 && (
          <div className="mb-4">
            <label className="block text-sm font-medium text-gray-700 mb-2">
              {t('download.result.selectResolution')}:
            </label>
            <div className="flex flex-wrap gap-2">
              {filteredResolutions.map((resource: DisplayResource, resIndex: number) => {
                const isPremiumOption = resIndex === 0 && !isAuthenticated;
                return (
                  <button
                    key={resIndex}
                    onClick={() => handleResolutionClick(resource, resIndex)}
                    className={`px-3 py-1.5 text-sm rounded-full border transition-colors ${
                      selectedResolution === resource
                        ? 'bg-purple-600 text-white border-purple-600'
                        : isPremiumOption
                          ? 'bg-gradient-to-r from-yellow-50 to-orange-50 text-gray-700 border-yellow-300 hover:border-yellow-400 cursor-pointer'
                          : 'bg-white text-gray-600 border-gray-300 hover:border-gray-400'
                    } ${isPremiumOption ? 'relative' : ''}`}
                  >
                    {getResolutionLabel(resIndex, isAuthenticated, resource, t)}
                    {isPremiumOption && (
                      <span className="ml-1 text-xs text-yellow-600">VIP</span>
                    )}
                  </button>
                );
              })}
            </div>
            {/* ÂΩìÂâçÈÄâÊã©ÁöÑÂàÜËæ®Áéá‰ø°ÊÅØ */}
            <div className="mt-2 text-xs text-gray-500">
              {currentWidth} √ó {currentHeight} ‚Ä¢ {currentLabel}
            </div>
          </div>
        )}
        
        {/* Êìç‰ΩúÊåâÈíÆÂå∫Âüü */}
        <div className="flex gap-2">
          <Button
            size="sm"
            variant="outline"
            className="flex-1 text-gray-700 hover:text-gray-900"
            onClick={() => {
              console.log('üñ±Ô∏è È¢ÑËßàÊåâÈíÆË¢´ÁÇπÂáª:', {
                is_video: media.is_video,
                downloadUrl,
                currentUrl,
                video_url: media.video_url,
                ‰º†ÈÄíÁªôonImageClickÁöÑURL: media.is_video ? downloadUrl : currentUrl
              });
              onImageClick(media.is_video ? downloadUrl : currentUrl, `Instagram Â™í‰Ωì ${index + 1}`, media.is_video);
            }}
          >
            <ZoomIn className="w-4 h-4 mr-1" />
            {t('download.result.preview')}
          </Button>
          <Button
            size="sm"
            className="flex-1 bg-green-600 hover:bg-green-700 text-white relative overflow-hidden"
            disabled={isDownloading}
            onClick={() => onDirectDownload(
              downloadUrl, 
              `instagram-${media.id || index}-${media.is_video ? 'video' : `${currentWidth}x${currentHeight}`}.${media.is_video ? 'mp4' : 'jpg'}`
            )}
          >
            {isDownloading ? (
              <>
                <Loader2 className="w-4 h-4 mr-1 animate-spin" />
                ‰∏ãËΩΩ‰∏≠
                <span className="absolute inset-0 bg-white/10 animate-pulse" />
              </>
            ) : (
              <>
                <Download className="w-4 h-4 mr-1" />
                {t('common.download')}
              </>
            )}
          </Button>
          <Button
            size="sm"
            variant="outline"
            className="text-gray-700 hover:text-gray-900"
            onClick={() => onCopyUrl()}
          >
            <Copy className="w-4 h-4" />
          </Button>
        </div>
      </div>
    </motion.div>
  );
}
